@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="wrapper wrapper-content animated fadeInUp">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>資料備份</h5>
                    <div class="ibox-tools">
                        <a class="btn btn-info btn-xs p210" id="backupapplication" action="BackUpApplication"><i class="fa fa-cubes fa-fw"></i> 備份程式</a>
                        <a class="btn btn-primary btn-xs p210" id="backupdatabase" action="BackUpDataBase"><i class="fa fa-database fa-fw"></i> 備份資料</a>
                        <a class="btn btn-danger btn-xs p210" id="delete" action="remove"><i class="fa fa-trash-o fa-fw"></i> 刪除備份</a>
                        <a class="reload-link" style="color: #c4c4c4" href="javascript:dig.reload()" data-toggle="tooltip" data-placement="left" title="刷新">
                            <i class="fa fa-repeat fa-lg"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-9">
                            <label>備份類型：</label>
                            <div class="btn-group">
                                <button class="btn btn-warning" type="button" data-type="*"><i class="fa fa-adn"></i> 全部</button>
                                <button class="btn btn-white" type="button" data-type=".zip"><i class="fa fa-cubes"></i> 程式備份</button>
                                <button class="btn btn-white" type="button" data-type=".bak"><i class="fa fa-database"></i> 資料備份</button>
                            </div>

                        </div>
                        <div class="col-sm-3">
                        </div>
                    </div>
                    <div class="row">
                        <table id="dataTable" class="table table-striped table-bordered table-hover dataTables-example" style="text-align:center;">
                            <thead>
                                <tr>
                                    <th class="tn" style="width: 50px !important"></th>
                                    <th>備份名稱</th>
                                    <th>備份類型</th>
                                    <th>備份大小</th>
                                    <th>備份時間</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <script id="tlist" type="text/x-jquery-tmpl">
                            <tr>
                                <td class="tn" style="width: 50px !important"><input name="check_files" type="checkbox" class="icheck_box" value="${path}" /></td>
                                <td>${name}</td>
                                <td>{{if ext==".zip" }}{{html '程式備份'}}{{else}}{{html '資料備份'}}{{/if}}</td>
                                <td>${size}</td>
                                <td>${time}</td>
                            </tr>
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script type="text/javascript" src="/Content/js/jquery.tmpl.js"></script>
    <script type="text/javascript">
        $(function () {
            ShowFiles('');
            //類型切換
            $(".btn-group button").click(function () {
                $(this).removeClass("btn-white").addClass("btn-warning").siblings().removeClass("btn-warning").addClass("btn-white");
                ShowFiles($(this).attr("data-type"));
            });
            //程式備份
            $("#backupapplication").click(function () {
                dig.addPage("備份程式", "/Com/BackupRestore/BackUpApplication", 600, 250, function () {
                    if (this.returnValue == 'yes') {
                        location.reload();
                    }
                });
            });
            //資料備份
            $("#backupdatabase").click(function () {
                dig.addPage("資料備份", "/Com/BackupRestore/BackUpDataBase", 600, 250, function () {
                    if (this.returnValue == 'yes') {
                        location.reload();
                    }
                });
            });
            //刪除備份
            $("#delete").click(function () {
                var vals = '';
                $('input[name="check_files"]:checked').each(function () {
                    vals += $(this).val() + ';';
                });
                if (vals == '' || vals == ';') {
                    dig.error("對不起，請選中您要操作的檔！");
                    return;
                }
                dig.confirm("刪除確認", "刪除後不可恢復,確定刪除嗎？", function () {
                    $.post("/Com/BackupRestore/DeleteBy", { path: vals }, function (res) {
                        if (res.Status == "y")
                            location.reload();
                        else {
                            dig.error(res.Msg);
                        }
                    }, "json");
                });
            });

        });
        function ShowFiles(n)
        {
            $("#dataTable>tbody").html('<tr><td colspan="5" ><div class="sk-spinner sk-spinner-cube-grid"><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div></div></td></tr>');
            $.post("/Com/BackupRestore/GetBackUpData", { fileExt: n }, function (res) {
                if (res.Status == "y") {
                    if (res.Data == "" || res.Data == null) {
                        $("#dataTable>tbody").html('<tr><td colspan="5" class="alert alert-warning text-center"><span style="font-size:16px;"><i class="fa fa-warning"></i>&nbsp;沒有找到任何檔</span></td></tr>');
                    } else {
                        $("#dataTable>tbody").empty();
                        $("#tlist").tmpl(res.Data).appendTo('#dataTable>tbody');
                        $(".icheck_box").iCheck({
                            checkboxClass: 'icheckbox_minimal-red',
                            radioClass: 'iradio_minimal-red',
                            increaseArea: '20%' // optional
                        });
                        //點擊表格，選中/取消 核取方塊
                        $("#dataTable tr").slice(1).each(function (g) {
                            var p = $(this);
                            $(this).children().slice(1).click(function () {
                                if ($($(p.children()[0]).children()[0]).children().eq(0).prop("checked")) {
                                    $($(p.children()[0]).children()[0]).iCheck("uncheck");
                                }
                                else {
                                    $($(p.children()[0]).children()[0]).iCheck("check");
                                }
                            });
                        });
                    }
                } else if (res.Status == "empty") {
                    $("#dataTable>tbody").html('<tr><td colspan="5" class="alert alert-warning text-center"><span style="font-size:16px;"><i class="fa fa-warning"></i>&nbsp;沒有找到任何檔</span></td></tr>');
                }
                else {
                    $("#dataTable>tbody").html('<tr><td colspan="5" class="alert alert-warning text-center"><span style="font-size:16px;"><i class="fa fa-warning"></i>&nbsp;' + res.Msg + '</span></td></tr>');
                }
            }, "json");
        }
    </script>
}


