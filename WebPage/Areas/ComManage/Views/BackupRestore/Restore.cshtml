@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="wrapper wrapper-content animated fadeInUp">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>資料還原</h5>
                    <div class="ibox-tools">
                        <a class="btn btn-info btn-xs p210" id="restore" action="RestoreData"><i class="fa fa-cubes fa-fw"></i> 還原資料</a>
                        <a class="btn btn-danger btn-xs p210" id="uploadbak" action="UploadBak"><i class="fa fa-cloud-upload fa-fw"></i> 上傳資料庫備份</a>
                        <a class="reload-link" style="color: #c4c4c4" href="javascript:dig.reload()" data-toggle="tooltip" data-placement="left" title="刷新">
                            <i class="fa fa-repeat fa-lg"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <table id="dataTable" class="table table-striped table-bordered table-hover dataTables-example" style="text-align:center;">
                            <thead>
                                <tr>
                                    <th class="tn" style="width: 50px !important"></th>
                                    <th>備份名稱</th>
                                    <th>備份類型</th>
                                    <th>備份大小</th>
                                    <th>備份時間</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <script id="tlist" type="text/x-jquery-tmpl">
                            <tr>
                                <td class="tn" style="width: 50px !important"><input name="check_files" type="checkbox" class="icheck_box" value="${path}" /></td>
                                <td>${name}</td>
                                <td>{{if ext==".zip" }}{{html '程式備份'}}{{else}}{{html '資料備份'}}{{/if}}</td>
                                <td>${size}</td>
                                <td>${time}</td>
                            </tr>
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script type="text/javascript" src="/Content/js/jquery.tmpl.js"></script>
    <script type="text/javascript">
        $(function () {
            ShowFiles();
            $("#restore").click(function () {
                var vals = '';
                var num = 0;
                $('input[name="check_files"]:checked').each(function () {
                    vals = $(this).val();
                    num++;
                });
                if (!vals) {
                    dig.error("對不起，請選中您要操作的檔！");
                    return;
                }
                if (num > 1) {
                    dig.error("對不起，只允許單個檔案還原操作！");
                    return;
                }
                if (vals.substring(vals.lastIndexOf('.'), vals.length) == ".zip") {
                    dig.error("無法對程式檔進行線上還原！");
                    return;
                }
                var msg = "將進行資料還原，您確定嗎？";
                dig.confirm("還原資料確認", msg, function () {
                    $.ajax({
                        type: "Post",
                        url: "/Com/BackupRestore/RestoreData",
                        data: {path:vals},
                        dataType: "json",
                        beforeSend: function () {
                            dig.loading("正在還原");
                        },
                        success: function (res) {
                            if (res.Status == "y") {
                                dig.successcallback(res.Msg, function () {
                                    window.location.reload();
                                });
                            } else {
                                dig.error(res.Msg);
                            }
                        },
                        error: function (e) {
                            dig.error("伺服器忙，請稍後再試！");
                        }
                    });
                });
            });
            $("#uploadbak").click(function () {
                dig.upload("/App_Data/BackUp/DataBaseBackUp/", function () {
                    var retval = this.returnValue;
                    if (retval != '') {
                        window.location.reload();
                    }
                });
            });
        });
        function ShowFiles()
        {
            $("#dataTable>tbody").html('<tr><td colspan="5" ><div class="sk-spinner sk-spinner-cube-grid"><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div><div class="sk-cube"></div></div></td></tr>');
            $.post("/Com/BackupRestore/GetBackUpData", { fileExt: "" }, function (res) {
                if (res.Status == "y") {
                    if (res.Data == "" || res.Data == null) {
                        $("#dataTable>tbody").html('<tr><td colspan="5" class="alert alert-warning text-center"><span style="font-size:16px;"><i class="fa fa-warning"></i>&nbsp;沒有找到任何檔</span></td></tr>');
                    } else {
                        $("#dataTable>tbody").empty();
                        $("#tlist").tmpl(res.Data).appendTo('#dataTable>tbody');
                        $(".icheck_box").iCheck({
                            checkboxClass: 'icheckbox_minimal-red',
                            radioClass: 'iradio_minimal-red',
                            increaseArea: '20%' // optional
                        });
                        //點擊表格，選中/取消 核取方塊
                        $("#dataTable tr").slice(1).each(function (g) {
                            var p = $(this);
                            $(this).children().slice(1).click(function () {
                                if ($($(p.children()[0]).children()[0]).children().eq(0).prop("checked")) {
                                    $($(p.children()[0]).children()[0]).iCheck("uncheck");
                                }
                                else {
                                    $($(p.children()[0]).children()[0]).iCheck("check");
                                }
                            });
                        });
                    }
                } else if (res.Status == "empty") {
                    $("#dataTable>tbody").html('<tr><td colspan="5" class="alert alert-warning text-center"><span style="font-size:16px;"><i class="fa fa-warning"></i>&nbsp;沒有找到任何檔</span></td></tr>');
                }
                else {
                    $("#dataTable>tbody").html('<tr><td colspan="5" class="alert alert-warning text-center"><span style="font-size:16px;"><i class="fa fa-warning"></i>&nbsp;' + res.Msg + '</span></td></tr>');
                }
            }, "json");
        }
    </script>
}